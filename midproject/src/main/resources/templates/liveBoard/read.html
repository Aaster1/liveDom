<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/UI/user/layout/main_layout}"
      >
<head>
    <title>공연 게시글 읽기</title>
</head>
<body layout:fragment="content">
  <h1>공연 게시글 읽기</h1>
    <form action="/liveBoard/delete" method="POST" id="form">
        <input type="hidden" name="boardNo" th:value="${liveBoard.boardNo}" id="boardNo">

        <h2 th:text="${liveBoard.title}"></h2>
        
        <img th:src="|/file/img/${liveBoard.thumbnail.fileNo}|" style="width: 200px;" th:if="${liveBoard.thumbnail != null}">

        <table>
            <tr>
                <td>공연일자</td>
                <td>
                    <span th:text="${liveBoard.liveDate}"></span>
                </td>
            </tr>
            <tr>
                <td>공연시간</td>
                <td>
                    <span th:text="${liveBoard.liveTime}"></span>
                </td>
            </tr>
            <tr>
                <td>공연진</td>
                <td>
                    <span th:text="${liveBoard.crew}"></span>
                </td>
            </tr>
            <tr>
                <td>수용인원</td>
                <td>
                    <span th:text="${liveBoard.maxTickets}"></span>
                </td>
            </tr>
            <tr>
                <td>티켓가격</td>
                <td>
                    <span th:text="${liveBoard.price}"></span>
                </td>
            </tr>
            <tr>
                <td>지역</td>
                <td>
                    <span th:text="${liveBoard.location}"></span>
                </td>
            </tr>
            <tr>
                <td>잔여티켓</td>
                <td>
                    <span th:text="${liveBoard.ticketLeft}" id="ticketLeft"></span>
                </td>
            </tr>
            <tr>
                <td>매진여부</td>
                <td>
                    <span th:if="${liveBoard.soldOut == 0}">판매 중</span> 
                    <span th:if="${liveBoard.soldOut == 1}">매진</span> 
                </td>
            </tr>
            <tr>
                <td>매수</td>
                <td>
                    <!-- 버튼 클릭 시 숫자가 증감함 -->
                    <div>
                        <h3 id="countNum">0</h3>
                        <div id="countBtn" onclick="increase()">+</div>
                        <div id="countBtn" onclick="decrease()">-</div>
                    </div>
                </td>
            </tr>

        </table>
    </form>
    <th:block th:if="${#authorization.expression('isAuthenticated()')}">
        <form action="/liveBoard/purchase" method="POST" id="purchase">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="_csrf"/>
            <input type="hidden" id="boardNo"    name="boardNo" th:value="${liveBoard.boardNo}">
            <input type="hidden" id="name"     name="name" th:value="${#authentication.principal.users.name}" >
            <input type="hidden" id="phone"  name="phone" th:value="${#authentication.principal.users.phone}" >
            <input type="hidden" id="count"   name="count" value="0">
            
    
            <button type="button" id="btn-purchase">티켓 구매</button>
        </form>
    </th:block>

    <div>
        <button type="button" onclick="moveList()">목록</button>
        <th:block th:if="${#authorization.expression('isAuthenticated()')}">

            <button type="button" onclick="moveUpdate()" th:if="${#authentication.principal.users.username == liveBoard.username}">수정</button>
        </th:block>
    </div>

    <div style="background-color: darkgrey; width: 500px; height: 800px;">
        <p th:utext="${liveBoard.content}"></p>
    </div>

    <script>

        
        // 목록으로 이동
        function moveList() {
            location.href = "/liveBoard/list"
        }

        // 수정으로 이동
        function moveUpdate() {
            const boardNo = $('#boardNo').val()
            location.href = "/liveBoard/update?boardNo=" + boardNo;
        }
       

         // 등록 버튼 - 클릭 이벤트
        $('#btn-purchase').on('click', function() {
            // 등록 요청
            let formData = new FormData()       // 폼 데이터 객체
            let _csrf_name = $('#_csrf').attr('name')
            let _csrf_value = $('#_csrf').val()
            let boardNo = $('#boardNo').val()
            let name = $('#name').val()
            let phone = $('#phone').val()
            let count = $('#count').val()
            formData.append(_csrf_name, _csrf_value )
            formData.append('boardNo', boardNo)
            formData.append('name', name)
            formData.append('phone', phone)
            formData.append('count', count)
            

            let url = 'http://localhost:8080/liveBoard/purchase'
            $.ajax({
                url             :   url,
                type            :   'POST',
                data            :   formData,
                contentType     :   false,
                processData     :   false,      // 데이터 컨텐츠 타입 자동 변환 여부
                                                // 기본값(true) 
                                                // true  -> contentType  : application/x-www-form-urlencoded
                                                // false -> contentType  : 데이터를 자동으로 처리하지 않고 직접 지정
                success         : function(response) {
                    if( response == 'SUCCESS' ){
                        alert('티켓 구매가 완료되었습니다.')
                        location.reload();
                    }
                    if( response == 'OVERCOUNT' ){
                        alert('잔여티켓보다 구매티켓 수가 많습니다.')
                    }
                    if( response == 'FAIL' ){
                        alert('티켓 구매에 실패했습니다.')
                    }
                    if( response == 'ZERO' ){
                        alert('매진되었습니다.')
                    }

                },
                error           : function(request, status, error){
                    alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                }

            })


        })

        // 매수 카운트 1 증가
        var count=0;
        function increase(){
            count=count+1;
            document.querySelector("#countNum").innerText=count;
            $("#count").val(count)
        }

        // 매수 카운트 1 감소
        function decrease(){
            if ( document.querySelector("#countNum").innerText > 0 ) {
                count=count-1;
                document.querySelector("#countNum").innerText=count;
                $("#count").val(count)
            }
        }

    </script>
</body>
</html>